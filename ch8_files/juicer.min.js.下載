
/**
 * Juicer 是一个高效、轻量的前端 (Javascript) 模板引擎，
 * 使用 Juicer 可以是你的代码实现数据和视图模型的分离(MVC)。
 * 除此之外，它还可以在 Node.js 环境中运行。
 */
! function() {
	var e = function() {
			var i = [].slice.call(arguments);
			return i.push(e.options), i[0].match(/^\s*#([\w:\-\.]+)\s*$/gim) && i[0].replace(/^\s*#([\w:\-\.]+)\s*$/gim,
				function(e, t) {
					var a = document,
						n = a && a.getElementById(t);
					i[0] = n ? n.value || n.innerHTML : e
				}), e.documentHTML && (e.compile.call(e, e.documentHTML), e.documentHTML = ""), 1 == arguments.length ? e.compile.apply(
				e, i) : arguments.length >= 2 ? e.to_html.apply(e, i) : void 0
		},
		i = {
			escapehash: {
				"<": "&lt;",
				">": "&gt;",
				"&": "&amp;",
				'"': "&quot;",
				"'": "&#x27;",
				"/": "&#x2f;"
			},
			escapereplace: function(e) {
				return i.escapehash[e]
			},
			escaping: function(e) {
				return "string" != typeof e ? e : e.replace(/[&<>"']/gim, this.escapereplace)
			},
			detection: function(e) {
				return "undefined" == typeof e ? "" : e
			}
		},
		t = function(e) {
			if ("undefined" != typeof console) {
				if (console.warn) return void console.warn(e);
				if (console.log) return void console.log(e)
			}
			throw e
		},
		a = function(e, i) {
			if (e = e !== Object(e) ? {} : e, e.__proto__) return e.__proto__ = i, e;
			var t = function() {},
				a = Object.create ? Object.create(i) : new(t.prototype = i, t);
			for (var n in e) e.hasOwnProperty(n) && (a[n] = e[n]);
			return a
		},
		n = function(e) {
			var s, d, p, i = /^function\s*[^\(]*\(\s*([^\)]*)\)/m,
				t = /,/,
				a = /^\s*(_?)(\S+?)\1\s*$/,
				n = /^function[^{]+{([\s\S]*)}/m,
				r = [];
			"function" == typeof e ? e.length && (s = e.toString()) : "string" == typeof e && (s = e), s = s.trim(), p = s.match(
				i), d = s.match(n)[1].trim();
			for (var l = 0; l < p[1].split(t).length; l++) {
				var f = p[1].split(t)[l];
				f.replace(a, function(e, i, t) {
					r.push(t)
				})
			}
			return [r, d]
		};
	e.__cache = {}, e.version = "0.6.14", e.settings = {}, e.documentHTML = "", e.tags = {
			operationOpen: "{@",
			operationClose: "}",
			interpolateOpen: "\\${",
			interpolateClose: "}",
			noneencodeOpen: "\\$\\${",
			noneencodeClose: "}",
			commentOpen: "\\{#",
			commentClose: "\\}"
		}, e.options = {
			cache: !0,
			strip: !0,
			errorhandling: !0,
			detection: !0,
			_method: a({
				__escapehtml: i,
				__throw: t,
				__juicer: e
			}, {})
		}, e.tagInit = function() {
			var i = e.tags.operationOpen + "each\\s*([^}]*?)\\s*as\\s*(\\w*?)\\s*(,\\s*\\w*?)?" + e.tags.operationClose,
				t = e.tags.operationOpen + "\\/each" + e.tags.operationClose,
				a = e.tags.operationOpen + "if\\s*([^}]*?)" + e.tags.operationClose,
				n = e.tags.operationOpen + "\\/if" + e.tags.operationClose,
				o = e.tags.operationOpen + "else" + e.tags.operationClose,
				r = e.tags.operationOpen + "else if\\s*([^}]*?)" + e.tags.operationClose,
				s = e.tags.interpolateOpen + "([\\s\\S]+?)" + e.tags.interpolateClose,
				d = e.tags.noneencodeOpen + "([\\s\\S]+?)" + e.tags.noneencodeClose,
				p = e.tags.commentOpen + "[^}]*?" + e.tags.commentClose,
				l = e.tags.operationOpen + "each\\s*(\\w*?)\\s*in\\s*range\\(([^}]+?)\\s*,\\s*([^}]+?)\\)" + e.tags.operationClose,
				f = e.tags.operationOpen + "include\\s*([^}]*?)\\s*,\\s*([^}]*?)" + e.tags.operationClose,
				u = e.tags.operationOpen + "helper\\s*([^}]*?)\\s*" + e.tags.operationClose,
				c = "([\\s\\S]*?)",
				g = e.tags.operationOpen + "\\/helper" + e.tags.operationClose;
			e.settings.forstart = new RegExp(i, "igm"), e.settings.forend = new RegExp(t, "igm"), e.settings.ifstart = new RegExp(
					a, "igm"), e.settings.ifend = new RegExp(n, "igm"), e.settings.elsestart = new RegExp(o, "igm"), e.settings.elseifstart =
				new RegExp(r, "igm"), e.settings.interpolate = new RegExp(s, "igm"), e.settings.noneencode = new RegExp(d, "igm"),
				e.settings.inlinecomment = new RegExp(p, "igm"), e.settings.rangestart = new RegExp(l, "igm"), e.settings.include =
				new RegExp(f, "igm"), e.settings.helperRegister = new RegExp(u + c + g, "igm")
		}, e.tagInit(), e.set = function(e, i) {
			var t = this,
				a = function(e) {
					return e.replace(/[\$\(\)\[\]\+\^\{\}\?\*\|\.]/gim, function(e) {
						return "\\" + e
					})
				},
				n = function(e, i) {
					var n = e.match(/^tag::(.*)$/i);
					return n ? (t.tags[n[1]] = a(i), void t.tagInit()) : void(t.options[e] = i)
				};
			if (2 === arguments.length) return void n(e, i);
			if (e === Object(e))
				for (var o in e) e.hasOwnProperty(o) && n(o, e[o])
		}, e.register = function(e, i) {
			var t = this.options._method;
			return t.hasOwnProperty(e) ? !1 : t[e] = i
		}, e.unregister = function(e) {
			var i = this.options._method;
			return i.hasOwnProperty(e) ? delete i[e] : void 0
		}, e.template = function(i) {
			var t = this;
			this.options = i, this.__interpolate = function(e, i, t) {
				var o, a = e.split("|"),
					n = a[0] || "";
				return a.length > 1 && (e = a.shift(), o = a.shift().split(","), n = "_method." + o.shift() + ".call({}, " + [e].concat(
					o) + ")"), "<%= " + (i ? "_method.__escapehtml.escaping" : "") + "(" + (t && t.detection === !1 ? "" :
					"_method.__escapehtml.detection") + "(" + n + ")) %>"
			}, this.__removeShell = function(i, a) {
				var o = 0;
				return i = i.replace(e.settings.helperRegister, function(i, t, a) {
					var o = n(a),
						r = o[0],
						s = o[1],
						d = new Function(r.join(","), s);
					return e.register(t, d), i
				}).replace(e.settings.forstart, function(e, i, t, a) {
					var t = t || "value",
						a = a && a.substr(1),
						n = "i" + o++;
					return "<% ~function() {for(var " + n + " in " + i + ") {if(" + i + ".hasOwnProperty(" + n + ")) {var " + t +
						"=" + i + "[" + n + "];" + (a ? "var " + a + "=" + n + ";" : "") + " %>"
				}).replace(e.settings.forend, "<% }}}(); %>").replace(e.settings.ifstart, function(e, i) {
					return "<% if(" + i + ") { %>"
				}).replace(e.settings.ifend, "<% } %>").replace(e.settings.elsestart, function(e) {
					return "<% } else { %>"
				}).replace(e.settings.elseifstart, function(e, i) {
					return "<% } else if(" + i + ") { %>"
				}).replace(e.settings.noneencode, function(e, i) {
					return t.__interpolate(i, !1, a)
				}).replace(e.settings.interpolate, function(e, i) {
					return t.__interpolate(i, !0, a)
				}).replace(e.settings.inlinecomment, "").replace(e.settings.rangestart, function(e, i, t, a) {
					var n = "j" + o++;
					return "<% ~function() {for(var " + n + "=" + t + ";" + n + "<" + a + ";" + n + "++) {{var " + i + "=" + n +
						"; %>"
				}).replace(e.settings.include, function(e, i, t) {
					return i.match(/^file\:\/\//gim) ? e : "<%= _method.__juicer(" + i + ", " + t + "); %>"
				}), a && a.errorhandling === !1 || (i = "<% try { %>" + i, i +=
					'<% } catch(e) {_method.__throw("Juicer Render Exception: "+e.message);} %>'), i
			}, this.__toNative = function(e, i) {
				return this.__convert(e, !i || i.strip)
			}, this.__lexicalAnalyze = function(i) {
				var t = [],
					a = [],
					n = "",
					o = ["if", "each", "_", "_method", "console", "break", "case", "catch", "continue", "//debugger", "default",
						"delete", "do", "finally", "for", "function", "in", "instanceof", "new", "return", "switch", "this", "throw",
						"try", "typeof", "var", "void", "while", "with", "null", "typeof", "class", "enum", "export", "extends",
						"import", "super", "implements", "interface", "let", "package", "private", "protected", "public", "static",
						"yield", "const", "arguments", "true", "false", "undefined", "NaN"
					],
					r = function(e, i) {
						if (Array.prototype.indexOf && e.indexOf === Array.prototype.indexOf) return e.indexOf(i);
						for (var t = 0; t < e.length; t++)
							if (e[t] === i) return t;
						return -1
					},
					s = function(i, n) {
						if (n = n.match(/\w+/gim)[0], -1 === r(t, n) && -1 === r(o, n) && -1 === r(a, n)) {
							if ("undefined" != typeof window && "function" == typeof window[n] && window[n].toString().match(
									/^\s*?function \w+\(\) \{\s*?\[native code\]\s*?\}\s*?$/i)) return i;
							if ("undefined" != typeof global && "function" == typeof global[n] && global[n].toString().match(
									/^\s*?function \w+\(\) \{\s*?\[native code\]\s*?\}\s*?$/i)) return i;
							if ("function" == typeof e.options._method[n] || e.options._method.hasOwnProperty(n)) return a.push(n), i;
							if (n.match(/^\d+/gim)) return i;
							t.push(n)
						}
						return i
					};
				i.replace(e.settings.forstart, s).replace(e.settings.interpolate, s).replace(e.settings.ifstart, s).replace(e.settings
					.elseifstart, s).replace(e.settings.include, s).replace(/[\+\-\*\/%!\?\|\^&~<>=,\(\)\[\]]\s*([A-Za-z_0-9]+)/gim,
					s);
				for (var d = 0; d < t.length; d++) n += "var " + t[d] + "=_." + t[d] + ";";
				for (var d = 0; d < a.length; d++) n += "var " + a[d] + "=_method." + a[d] + ";";
				return "<% " + n + " %>"
			}, this.__convert = function(e, i) {
				var t = [].join("");
				return t += "'use strict';", t += "var _=_||{};", t += "var _out='';_out+='", t += i !== !1 ? e.replace(/\\/g,
					"\\\\").replace(/[\r\t\n]/g, " ").replace(/'(?=[^%]*%>)/g, "	").split("'").join("\\'").split("	").join("'").replace(
					/<%=(.+?)%>/g, "';_out+=$1;_out+='").split("<%").join("';").split("%>").join("_out+='") + "';return _out;" : e.replace(
					/\\/g, "\\\\").replace(/[\r]/g, "\\r").replace(/[\t]/g, "\\t").replace(/[\n]/g, "\\n").replace(/'(?=[^%]*%>)/g,
					"	").split("'").join("\\'").split("	").join("'").replace(/<%=(.+?)%>/g, "';_out+=$1;_out+='").split("<%").join(
					"';").split("%>").join("_out+='") + "';return _out.replace(/[\\r\\n]\\s+[\\r\\n]/g, '\\r\\n');"
			}, this.parse = function(e, i) {
				var n = this;
				return i && i.loose === !1 || (e = this.__lexicalAnalyze(e) + e), e = this.__removeShell(e, i), e = this.__toNative(
					e, i), this._render = new Function("_, _method", e), this.render = function(e, i) {
					return i && i === t.options._method || (i = a(i, t.options._method)), n._render.call(this, e, i)
				}, this
			}
		}, e.compile = function(e, i) {
			i && i === this.options || (i = a(i, this.options));
			var n = this,
				o = {
					get: function(e) {
						return i.cachestore ? i.cachestore.get(e) : n.__cache[e]
					},
					set: function(e, t) {
						return i.cachestore ? i.cachestore.set(e, t) : n.__cache[e] = t
					}
				};
			try {
				var r = o.get(e) ? o.get(e) : new this.template(this.options).parse(e, i);
				return i && i.cache === !1 || o.set(e, r), r
			} catch(s) {
				return t("Juicer Compile Exception: " + s.message), {
					render: function() {}
				}
			}
		}, e.to_html = function(e, i, t) {
			return t && t === this.options || (t = a(t, this.options)), this.compile(e, t).render(i, t._method)
		}, "undefined" != typeof global && "undefined" == typeof window && e.set("cache", !1), "undefined" != typeof document &&
		document.body && (e.documentHTML = document.body.innerHTML), "undefined" != typeof module && module.exports ? module.exports =
		e : this.juicer = e
}();
